local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local userInputService = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local camera = workspace.CurrentCamera

-- Ayarlar
local flying = false
local noclip = false
local defaultGravity = workspace.Gravity
local flyLoop
local darkTheme = true
local espEnabled = false

-- ESP Sistemi
local ESP = {
    Boxes = {},
    Names = {},
    TeamCheck = false
}

function ESP:Toggle(enable)
    if enable then
        self:Create()
    else
        self:Clear()
    end
end

function ESP:Create()
    self:Clear()

    for _, targetPlayer in ipairs(Players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character then
            local char = targetPlayer.Character
            if char:FindFirstChild("HumanoidRootPart") then
                -- Kutu ESP
                local box = Instance.new("BoxHandleAdornment")
                box.Name = targetPlayer.Name .. "_ESPBox"
                box.Adornee = char.HumanoidRootPart
                box.AlwaysOnTop = true
                box.ZIndex = 5
                box.Size = Vector3.new(4, 6, 1)
                box.Transparency = 0.7
                box.Color3 = self.TeamCheck and targetPlayer.Team == player.Team
                    and Color3.new(0, 1, 0) or Color3.new(1, 0, 0)
                box.Parent = char.HumanoidRootPart
                self.Boxes[targetPlayer] = box

                -- İsim Etiketi
                local billboard = Instance.new("BillboardGui")
                billboard.Name = targetPlayer.Name .. "_ESPName"
                billboard.Adornee = char.Head
                billboard.Size = UDim2.new(0, 200, 0, 50)
                billboard.StudsOffset = Vector3.new(0, 2.5, 0)
                billboard.AlwaysOnTop = true

                local textLabel = Instance.new("TextLabel")
                textLabel.Text = targetPlayer.Name
                textLabel.Size = UDim2.new(1, 0, 1, 0)
                textLabel.BackgroundTransparency = 1
                textLabel.TextColor3 = box.Color3
                textLabel.TextStrokeTransparency = 0.5
                textLabel.Font = Enum.Font.GothamBold
                textLabel.TextSize = 14
                textLabel.Parent = billboard

                billboard.Parent = char.Head
                self.Names[targetPlayer] = billboard
            end
        end
    end
end

function ESP:Clear()
    for _, box in pairs(self.Boxes) do
        box:Destroy()
    end
    for _, name in pairs(self.Names) do
        name:Destroy()
    end
    self.Boxes = {}
    self.Names = {}
end

-- ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "VolixHubGui"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

local frameSize = UDim2.new(0, 400, 0, 250)
local framePos = UDim2.new(0.5, -200, 0.5, -125)

-- Loading Frame
local loadingFrame = Instance.new("Frame")
loadingFrame.Size = frameSize
loadingFrame.Position = framePos
loadingFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
loadingFrame.BorderSizePixel = 0
loadingFrame.Parent = screenGui

Instance.new("UICorner", loadingFrame).CornerRadius = UDim.new(0, 12)

local loadingText = Instance.new("TextLabel")
loadingText.Size = UDim2.new(0.6, 0, 0.3, 0)
loadingText.Position = UDim2.new(0.2, 0, 0.25, 0)
loadingText.BackgroundTransparency = 1
loadingText.Text = "Loading..."
loadingText.TextColor3 = Color3.fromRGB(255, 255, 255)
loadingText.Font = Enum.Font.GothamBold
loadingText.TextScaled = true
loadingText.Parent = loadingFrame

local volixHubText = Instance.new("TextLabel")
volixHubText.Size = UDim2.new(0.6, 0, 0.2, 0)
volixHubText.Position = UDim2.new(0.2, 0, 0.05, 0)
volixHubText.BackgroundTransparency = 1
volixHubText.Text = "Volix Hub V2.5"
volixHubText.TextColor3 = Color3.fromRGB(255, 255, 255)
volixHubText.Font = Enum.Font.GothamBold
volixHubText.TextScaled = true
volixHubText.Parent = loadingFrame

local barBG = Instance.new("Frame")
barBG.Size = UDim2.new(1, -40, 0, 20)
barBG.Position = UDim2.new(0, 20, 1, -30)
barBG.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
barBG.BorderSizePixel = 0
barBG.Parent = loadingFrame

Instance.new("UICorner", barBG).CornerRadius = UDim.new(0, 6)

local progressBar = Instance.new("Frame")
progressBar.Size = UDim2.new(0, 0, 1, 0)
progressBar.BackgroundColor3 = Color3.fromRGB(50, 50, 255)
progressBar.Parent = barBG
Instance.new("UICorner", progressBar).CornerRadius = UDim.new(0, 6)

TweenService:Create(progressBar, TweenInfo.new(3), { Size = UDim2.new(1, 0, 1, 0) }):Play()
task.wait(3)

-- Hide Loading
for _, child in ipairs(loadingFrame:GetChildren()) do
    if child:IsA("GuiObject") then
        TweenService:Create(child, TweenInfo.new(1), {
            BackgroundTransparency = 1,
            TextTransparency = child:IsA("TextLabel") and 1 or nil
        }):Play()
    end
end

TweenService:Create(loadingFrame, TweenInfo.new(1), { BackgroundTransparency = 1 }):Play()
TweenService:Create(barBG, TweenInfo.new(1), { BackgroundTransparency = 1 }):Play()
TweenService:Create(progressBar, TweenInfo.new(1), { BackgroundTransparency = 1 }):Play()

task.delay(1, function()
    loadingFrame:Destroy()

    -- Main GUI
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = frameSize
    mainFrame.Position = framePos
    mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    mainFrame.BackgroundTransparency = 1
    mainFrame.Active = true
    mainFrame.Draggable = true
    mainFrame.Parent = screenGui
    Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(0, 150, 0, 25)
    title.Position = UDim2.new(1, -155, 0, 5)
    title.BackgroundTransparency = 1
    title.Text = "Volix Hub V2.5"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.TextXAlignment = Enum.TextXAlignment.Right
    title.Parent = mainFrame

    local closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 30, 0, 25)
    closeButton.Position = UDim2.new(0, 5, 0, 5)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.Font = Enum.Font.SourceSansBold
    closeButton.TextSize = 18
    closeButton.Parent = mainFrame
    Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 6)

    local settingsButton = Instance.new("TextButton")
    settingsButton.Name = "SettingsButton"
    settingsButton.Size = UDim2.new(0, 30, 0, 25)
    settingsButton.Position = UDim2.new(0, 40, 0, 5)
    settingsButton.BackgroundColor3 = Color3.fromRGB(70, 70, 255)
    settingsButton.Text = "⚙️"
    settingsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    settingsButton.Font = Enum.Font.SourceSansBold
    settingsButton.TextSize = 18
    settingsButton.Parent = mainFrame
    Instance.new("UICorner", settingsButton).CornerRadius = UDim.new(0, 6)

    local flyButton = Instance.new("TextButton")
    flyButton.Size = UDim2.new(0, 100, 0, 25)
    flyButton.Position = UDim2.new(0, 5, 0, 35)
    flyButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    flyButton.Text = "Fly"
    flyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    flyButton.Font = Enum.Font.SourceSansBold
    flyButton.TextSize = 18
    flyButton.Parent = mainFrame
    Instance.new("UICorner", flyButton).CornerRadius = UDim.new(0, 6)

    local flySpeedBox = Instance.new("TextBox")
    flySpeedBox.Size = UDim2.new(0, 50, 0, 25)
    flySpeedBox.Position = UDim2.new(0, 110, 0, 35)
    flySpeedBox.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    flySpeedBox.Text = "1"
    flySpeedBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    flySpeedBox.Font = Enum.Font.SourceSansBold
    flySpeedBox.TextSize = 18
    flySpeedBox.ClearTextOnFocus = false
    flySpeedBox.Parent = mainFrame
    Instance.new("UICorner", flySpeedBox).CornerRadius = UDim.new(0, 6)

    local noclipButton = Instance.new("TextButton")
    noclipButton.Size = UDim2.new(0, 100, 0, 25)
    noclipButton.Position = UDim2.new(0, 5, 0, 70)
    noclipButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    noclipButton.Text = "NoClip"
    noclipButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    noclipButton.Font = Enum.Font.SourceSansBold
    noclipButton.TextSize = 18
    noclipButton.Parent = mainFrame
    Instance.new("UICorner", noclipButton).CornerRadius = UDim.new(0, 6)

    local espButton = Instance.new("TextButton")
    espButton.Name = "ESPButton"
    espButton.Size = UDim2.new(0, 100, 0, 25)
    espButton.Position = UDim2.new(0, 5, 0, 105)
    espButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    espButton.Text = "ESP: OFF"
    espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    espButton.Font = Enum.Font.SourceSansBold
    espButton.TextSize = 18
    espButton.Parent = mainFrame
    Instance.new("UICorner", espButton).CornerRadius = UDim.new(0, 6)

    -- Güncellenmiş Ayarlar Paneli
    local settingsPanel = Instance.new("Frame")
    settingsPanel.Name = "SettingsPanel"
    settingsPanel.Size = UDim2.new(1, -10, 1, -40) -- Ana frame'i kapla
    settingsPanel.Position = UDim2.new(0, 5, 0, 35) -- Üstteki butonların altından başla
    settingsPanel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    settingsPanel.Visible = false
    settingsPanel.Parent = mainFrame
    Instance.new("UICorner", settingsPanel).CornerRadius = UDim.new(0, 8)

    local themeButton = Instance.new("TextButton")
    themeButton.Size = UDim2.new(0, 160, 0, 30)
    themeButton.Position = UDim2.new(0.5, -80, 0, 20)
    themeButton.AnchorPoint = Vector2.new(0.5, 0)
    themeButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    themeButton.Text = "Tema: Dark"
    themeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    themeButton.Font = Enum.Font.SourceSansBold
    themeButton.TextSize = 16
    themeButton.Parent = settingsPanel
    Instance.new("UICorner", themeButton).CornerRadius = UDim.new(0, 6)

    local configButton = Instance.new("TextButton")
    configButton.Size = UDim2.new(0, 160, 0, 30)
    configButton.Position = UDim2.new(0.5, -80, 0, 60)
    configButton.AnchorPoint = Vector2.new(0.5, 0)
    configButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    configButton.Text = "Config Save/Load"
    configButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    configButton.Font = Enum.Font.SourceSansBold
    configButton.TextSize = 14
    configButton.Parent = settingsPanel
    Instance.new("UICorner", configButton).CornerRadius = UDim.new(0, 6)

    local resetButton = Instance.new("TextButton")
    resetButton.Size = UDim2.new(0, 160, 0, 30)
    resetButton.Position = UDim2.new(0.5, -80, 0, 100)
    resetButton.AnchorPoint = Vector2.new(0.5, 0)
    resetButton.BackgroundColor3 = Color3.fromRGB(150, 50, 50)
    resetButton.Text = "Config Reset"
    resetButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    resetButton.Font = Enum.Font.SourceSansBold
    resetButton.TextSize = 14
    resetButton.Parent = settingsPanel
    Instance.new("UICorner", resetButton).CornerRadius = UDim.new(0, 6)

    TweenService:Create(mainFrame, TweenInfo.new(1), {
        BackgroundTransparency = 0
    }):Play()

    -- Buton Fonksiyonları
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    settingsButton.MouseButton1Click:Connect(function()
        settingsPanel.Visible = not settingsPanel.Visible

        -- Tüm butonların görünürlüğünü ayarla
        for _, child in ipairs(mainFrame:GetChildren()) do
            if child:IsA("TextButton") and child ~= settingsButton and child ~= closeButton then
                child.Visible = not settingsPanel.Visible
            end
        end

        -- Başlık ve close butonu hariç diğerlerini gizle
        title.Visible = not settingsPanel.Visible
        flySpeedBox.Visible = not settingsPanel.Visible
    end)

    flyButton.MouseButton1Click:Connect(function()
        flying = not flying
        if flying then
            humanoid.PlatformStand = true
            workspace.Gravity = 0
            flyButton.Text = "Un Fly"
            flyButton.BackgroundColor3 = Color3.fromRGB(50, 255, 50)

            flyLoop = runService.RenderStepped:Connect(function()
                local pos = humanoidRootPart.Position
                local look = (camera.Focus.Position - camera.CFrame.Position).Unit
                local move = Vector3.zero

                if userInputService:IsKeyDown(Enum.KeyCode.W) then move += Vector3.new(0, 0, -1) end
                if userInputService:IsKeyDown(Enum.KeyCode.S) then move += Vector3.new(0, 0, 1) end
                if userInputService:IsKeyDown(Enum.KeyCode.A) then move += Vector3.new(-1, 0, 0) end
                if userInputService:IsKeyDown(Enum.KeyCode.D) then move += Vector3.new(1, 0, 0) end
                if userInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0, 1, 0)
                elseif userInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move += Vector3.new(0, -1, 0) end

                local speed = tonumber(flySpeedBox.Text) or 1
                humanoidRootPart.CFrame = CFrame.new(pos, pos + look) * CFrame.new(move * speed)
            end)
        else
            humanoid.PlatformStand = false
            workspace.Gravity = defaultGravity
            flyButton.Text = "Fly"
            flyButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
            if flyLoop then flyLoop:Disconnect() end
        end
    end)

    noclipButton.MouseButton1Click:Connect(function()
        noclip = not noclip
        for _, part in ipairs(character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = not noclip
            end
        end
        noclipButton.Text = noclip and "Clip" or "NoClip"
        noclipButton.BackgroundColor3 = noclip and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
    end)

    espButton.MouseButton1Click:Connect(function()
        espEnabled = not espEnabled
        ESP:Toggle(espEnabled)
        espButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
        espButton.BackgroundColor3 = espEnabled and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)

        if _G.volixConfig then
            _G.volixConfig.espEnabled = espEnabled
        end
    end)

    themeButton.MouseButton1Click:Connect(function()
        darkTheme = not darkTheme
        local bgColor = darkTheme and Color3.fromRGB(35, 35, 35) or Color3.fromRGB(220, 220, 220)
        local panelColor = darkTheme and Color3.fromRGB(40, 40, 40) or Color3.fromRGB(180, 180, 180)
        local textColor = darkTheme and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(0, 0, 0)

        -- Ana frame ve ayar paneli rengi
        mainFrame.BackgroundColor3 = bgColor
        settingsPanel.BackgroundColor3 = panelColor

        -- Tüm text ve buton renkleri
        for _, child in ipairs(mainFrame:GetDescendants()) do
            if child:IsA("TextLabel") or child:IsA("TextButton") then
                child.TextColor3 = textColor
                if child:IsA("TextButton") and child ~= closeButton then
                    child.BackgroundColor3 = darkTheme and Color3.fromRGB(100, 100, 100) or Color3.fromRGB(150, 150, 150)
                end
            end
        end

        -- Özel buton renkleri (kırmızı/yeşil butonlar)
        closeButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
        flyButton.BackgroundColor3 = flying and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
        noclipButton.BackgroundColor3 = noclip and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
        espButton.BackgroundColor3 = espEnabled and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)

        themeButton.Text = "Tema: " .. (darkTheme and "Dark" or "Light")
        _G.volixConfig.darkTheme = darkTheme
    end)

    _G.volixConfig = _G.volixConfig or {}
    configButton.MouseButton1Click:Connect(function()
        if _G.volixConfig.speed then
            flySpeedBox.Text = tostring(_G.volixConfig.speed)
            mainFrame.BackgroundColor3 = _G.volixConfig.darkTheme and Color3.fromRGB(35, 35, 35) or Color3.fromRGB(220, 220, 220)
            darkTheme = _G.volixConfig.darkTheme
            themeButton.Text = "Tema: " .. (darkTheme and "Dark" or "Light")

            if _G.volixConfig.espEnabled ~= nil then
                espEnabled = _G.volixConfig.espEnabled
                ESP:Toggle(espEnabled)
                espButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
                espButton.BackgroundColor3 = espEnabled and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
            end
        else
            _G.volixConfig = {
                speed = tonumber(flySpeedBox.Text) or 1,
                darkTheme = darkTheme,
                espEnabled = espEnabled
            }
        end
    end)

    resetButton.MouseButton1Click:Connect(function()
        _G.volixConfig = {
            speed = 1,
            darkTheme = true,
            espEnabled = false
        }

        -- Ayarları resetle
        flySpeedBox.Text = "1"
        darkTheme = true
        espEnabled = false

        -- Görsel güncellemeler
        mainFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        themeButton.Text = "Tema: Dark"
        ESP:Toggle(false)
        espButton.Text = "ESP: OFF"
        espButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)

        -- Fly ve NoClip'i de resetle
        if flying then
            flyButton:Fire("MouseButton1Click")
        end
        if noclip then
            noclipButton:Fire("MouseButton1Click")
        end
    end)

    Players.PlayerAdded:Connect(function(newPlayer)
        newPlayer.CharacterAdded:Connect(function(char)
            if espEnabled then
                task.wait(1)
                ESP:Create()
            end
        end)
    end)

    -- Başlangıçta config yükle
    if _G.volixConfig then
        if _G.volixConfig.speed then
            flySpeedBox.Text = tostring(_G.volixConfig.speed)
        end

        if _G.volixConfig.darkTheme ~= nil then
            darkTheme = _G.volixConfig.darkTheme
            mainFrame.BackgroundColor3 = darkTheme and Color3.fromRGB(35, 35, 35) or Color3.fromRGB(220, 220, 220)
            themeButton.Text = "Tema: " .. (darkTheme and "Dark" or "Light")
        end

        if _G.volixConfig.espEnabled ~= nil then
            espEnabled = _G.volixConfig.espEnabled
            ESP:Toggle(espEnabled)
            espButton.Text = espEnabled and "ESP: ON" or "ESP: OFF"
            espButton.BackgroundColor3 = espEnabled and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
        end
    end
end)
